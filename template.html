<script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.5.5.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mousetrap/1.2.2/mousetrap.min.js"></script>
<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->

<div class="row skeleton"> <!-- Start Skeleton Row-->
    <div class="span6 "><!-- Start of Question and Submission DIV (column) -->
        <h1 id="question">Question</h1> <!-- The question will be loaded here -->



        <p class="lead"> You have found the following tracks</p> 
        <div id="addTrack" style="padding-bottom: 15px;"> <!-- Start DIV for the control buttons -->
            <button id="btn-add-track" class="btn btn-info btn-add-track" value="add_track"><i class="icon icon-plus"></i> Add a track</button>
        </div>

        <p id="track-start" style="display:none"> <strong>Mark the start of the current track</strong></p>
        <p id="track-exit" style="display:none"> <strong>Mark the exit of the current track</strong></p>
        <div id="track-type" style="display:none; padding-bottom:15px;"> 
            <p><strong>Can you count the number of particles in the track?</strong></p>
            <div class="btn-group">
                <button class="btn btn-mini track-type" value="thin"> Yes</button>
                <button class="btn btn-mini track-type" value="fat"> No</button>
            </div>
        </div>
        <div id="track-number-particles" style="display:none; padding-bottom:15px;"> 
            <p>How many particles do you count?</p>
            <div class="input-append">
                <input id="input-track-number-particles" class="span1" type="text"></input>
                <button id="save-track-number-particles" class="btn" type="button"> Done!</button>
            </div>
        </div>

        <div id="tracks">
        </div>

        <button id="save-tracks" class="btn btn-answer" value='save' style="display:none"><i class="icon-save"></i> Save drawn tracks</button>
        <!-- Feedback items for the user -->
        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
        <!-- Progress bar for the user -->
        <span id="total" class="label label-inverse"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
        -->
        <div id="disqus_show_btn" style="margin-top:5px;">
            <button class="btn btn-inverse btn-disqus" onclick="loadDisqus()"><i class="icon-comments"></i> Show comments</button>
            <button class="btn btn-large btn-disqus" onclick="loadDisqus()" style="display:none"><i class="icon-comments"></i> Hide comments</button>
        </div><!-- End of Disqus Button section -->
        <!-- Disqus thread for the given task -->
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>
    </div><!-- End of Question and Submission DIV (column) -->
    <div class="span6"><!-- Start of Photo DIV (column) -->
        <div id="canvas"></div>
        <div id="controls" class="btn-group" style="margin-top:5px;"> <!-- Start DIV for the control buttons -->
            <button class="btn btn-control" value='previous_frame'><i class="icon-backward"></i> Previous frame</button>
            <button class="btn btn-control" value='next_frame'><i class="icon-forward"></i> Next frame</button>
        </div> <!-- Start DIV for the control buttons -->
        <br/> 
        <p> Current frame  <span id="current_frame" class="badge badge-warning">0</span></p>

    </div><!-- End of Photo DIV (columnt) -->
</div><!-- End of Skeleton Row -->

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    function loadDisqus() {
    $("#disqus_thread").toggle();
    $(".btn-disqus").toggle();
    var disqus_shortname = 'pybossa'; // required: replace example with your forum shortname
    //var disqus_identifier = taskId;
    var disqus_developer = 1;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    }

</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<script>

var colors = ['rgb(31,119,180)', 'rgb(255,127,14)', 'rgb(44,160,44)', 'rgb(214,39,40)',
              'rgb(148,103,189)', 'rgb(227,119,194)', 'rgb(188,189,34)', 'rgb(23,190, 207)',
              'rgb(199,233,192)'
             ];

var colorIndex = 0;

function loadUserProgress() {
    pybossa.userProgress('antimatterbeta').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

function addTrack(task){
    if ((task.currentTrack.entry.x != -1) && (task.currentTrack.exit.x != -1)){
    var newTrack = $.extend(true, {}, task.currentTrack);
    // Unscale the points to save them with the real picture size
    newTrack = unscale(newTrack, $("#canvas").width(),$("#canvas").height());
    task.tracks.push(newTrack);
    task.currentTrack.entry.x = -1;
    task.currentTrack.entry.y = -1;
    task.currentTrack.entry.z = -1;
    task.currentTrack.exit.x = -1;
    task.currentTrack.exit.y = -1;
    task.currentTrack.exit.z = -1;
    task.currentTrack.n_particles = -1;
    $("#save-tracks").show();
    }
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        task.period = 20;
        task.maxPictures = 40;
        task.minPictures = 0;
        task.currentTrack = {entry:{x:-1, y:-1, z:-1}, exit:{x:-1, y:-1, z:-1}, n_particles:-1};
        task.tracks = [];
        task.trackLayers = [];
        task.step = "add-track";
        deferred.resolve(task);
    }
    else {
        deferred.resolve(task);
    }
});

function getNewAnimation(task) {
    var frameCounter = 0;
    var anim = new Kinetic.Animation(function(frameObj) {
        if (frameCounter/task.period < task.maxPictures) {
            if (frameCounter === 0 || frameCounter % task.period === 0) {
                var imageIndex = frameCounter === 0 ? 0 : frameCounter/task.period;
                var normalizedIndex = (imageIndex < 10) ? "0" + imageIndex : imageIndex;
                task.imageObj.src = task.info.url + normalizedIndex + '.jpg';
            }
        }
        else {
            frameCounter = 0;
        }
        frameCounter++;
    }, task.layer);
    return anim;
}


function goToFrame(task, frameNumber) {
     if (frameNumber > task.maxPictures || frameNumber < task.minPictures)
         return;
     var normalizedIndex = (frameNumber < 10) ? "0" + frameNumber : frameNumber;
     task.imageObj.src = task.info.url + normalizedIndex + '.jpg';
     task.layer.draw();
}

function unscale(track, width, height) {
    track.entry.x = Math.floor((track.entry.x * 1240)/width);
    track.entry.y = Math.floor((track.entry.y * 1024)/height);
    track.exit.x = Math.floor((track.exit.x * 1240)/width);
    track.exit.y = Math.floor((track.exit.y * 1024)/height);
    return track;
}

function formatFrame(task) {
    var frameStr = "00";
    if (task.frame <= 0) {
        task.frame = 0;
        frameStr = "00";
        return frameStr;
    }

    if ((task.frame >0) && (task.frame < 10)) {
        frameStr = "0" + task.frame.toString();
        return frameStr;
    }
    if ((task.frame >= 10) && (task.frame < 40)) {
        frameStr = task.frame.toString()
        return frameStr;
    }
    else {
        frameStr = "39";
        task.frame = 39;
        return frameStr;
    }
}

function loadFrame(task) {
    task.imageObj.src = task.info.url + formatFrame(task) + '.jpg';
    task.layer.draw();
    $("#current_frame").text(String(task.frame));
}


pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        // KINECT
        task.width =  460;
        task.height = Math.floor(task.width / 1.21); 
        task.stage = new Kinetic.Stage({
          container: 'canvas',
          width: task.width,
          height: task.height 
        });

        task.layer = new Kinetic.Layer();

        task.imageObj = new Image();
        var image = new Kinetic.Image({
            x: 0,
            y: 0,
            id: 'mainImage',
            image: task.imageObj,
            width: task.width,
            height: task.height
        });

        task.frame = 0;

        $("#tracks").html("");
        $("#current_frame").text("0");
        $(".btn-answer").hide();

        image.on('mousedown', function () {
            if ((task.step == "start-exit") && (task.trackLayers.length > 0)) {
                var index = task.trackLayers.length - 1;
                var mousePos = task.stage.getMousePosition();
                var circle = new Kinetic.Circle({
                    x: mousePos.x,
                    y: mousePos.y,
                    radius: 2,
                    fill: colors[colorIndex],
                    stroke: colors[colorIndex],
                    strokeWidth: 4
                });
                if (task.currentTrack.entry.x == -1) {
                    task.currentTrack.entry.x = mousePos.x;
                    task.currentTrack.entry.y = mousePos.y;
                    task.currentTrack.entry.z = task.frame;
                    $("#track_bar_" + index).css("width", "33%");
                    // Hide previous tooltip, and show new one
                    $("#track-start").hide();
                    $("#track-exit").show();
                }
                else {
                    if (task.currentTrack.exit.x == -1) {
                        task.currentTrack.exit.x = mousePos.x;
                        task.currentTrack.exit.y = mousePos.y;
                        task.currentTrack.exit.z = task.frame;
                        $("#track_bar_" + index).css("width", "66%");
                        // Hide previous tooltip, and show new one
                        $("#track-exit").hide();
                        $("#track-type").show();
                        task.step = "categorize-track";
                    }
                }

                //task.layer.add(circle);
                task.trackLayers[index].add(circle);
                task.trackLayers[index].draw();
                //task.layer.draw();
            }
        });
        task.imageObj.src = task.info.url + "00.jpg";

        // add the shape to the layer
        task.layer.add(image);

        // add the layer to the stage
        task.stage.add(task.layer);


        $(".btn-add-track").off('click').on('click', function(evt) {
            var action = $(evt.target).attr("value");

            if (action == 'add_track') {
                $("#btn-add-track").hide();
                task.step = "start-exit";
                $("#canvas").css("cursor", "crosshair");
                // Show action to do
                $("#track-start").show();
                // Change color per track
                if (colorIndex < colors.length) {
                    colorIndex += 1;
                }
                else {
                    colorIndex = 0;
                }
                var tmp = new Kinetic.Layer();
                task.trackLayers.push(tmp);
                task.stage.add(tmp);
                var trackID = task.trackLayers.length - 1;
                if (trackID == -1) {
                    trackID = 0;
                }
                var track = $("<div/>", {id: "track_" + trackID,
                                         class: 'progress progress-info progress-striped '});
                var bar = $("<div/>", {id: "track_bar_" + trackID, class: 'bar'});
                bar.css("width", "0%");
                track.append(bar);
                //track.text("Trac " + trackID);
                var btn = $("<button/>", {id: "track_" + trackID,
                                          class: 'delete-track btn btn-mini btn-danger pull-right'});
                btn.html("<i class='icon icon-remove'></i>");
                btn.off('click').on('click', function(){
                    var trackID = parseInt($(this).attr("id").split("track_")[1]);
                    task.trackLayers[trackID].destroy();
                    delete task.trackLayers[trackID];
                    delete task.tracks[trackID];
                    $("#track_" + trackID).remove();
                });
                track.append(btn);
                $("#tracks").prepend(track);
            }
        });

        $('.track-type').off('click').on('click', function(evt){
            var action = $(evt.target).attr("value");
            if (action == 'thin') {
                $("#track-type").hide();
                $("#track-number-particles").show();
            }
            else {
                $("#track-type").hide();
                var trackID = task.trackLayers.length - 1;
                $("#track_bar_" + trackID).css("width", "95%");
                task.step = "add-track";
                $("#canvas").css("cursor", "default");
                $("#btn-add-track").show();
                addTrack(task);
            }
        });

        $("#save-track-number-particles").off('click').on('click', function(){
            var trackID = task.trackLayers.length - 1;
            task.currentTrack.n_particles = parseInt($("#input-track-number-particles").val());
            addTrack(task);
            console.log(JSON.stringify(task.tracks));
            $("#track_bar_" + trackID).css("width", "95%");
            $("#btn-add-track").show();
            $("#track-number-particles").hide();
            task.step = "add-track";
            $("#canvas").css("cursor", "default");
        });
         

        $('.btn-control').off('click').on('click', function(evt) {
            var action = $(evt.target).attr("value");
            if (action == 'next_frame') {
                task.frame += 1;
                loadFrame(task);
            }

            if (action == 'previous_frame') {
                task.frame -= 1;
                loadFrame(task);
            }
        });

        // Keyboard actions
        Mousetrap.bind('right', function(e) {
            task.frame += 1;
            loadFrame(task);
        });

        Mousetrap.bind('left', function(e) {
            task.frame -= 1;
            loadFrame(task);
        });


        $('.btn-track-control').off('click').on('click', function(evt) {
            var action = $(evt.target).attr("value");
            if (action == 'add') {
                console.log(action);
            }
        });

        $("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $('.btn-answer').off('click').on('click', function(evt) {
            var action = $(evt.target).attr("value");
            if (action == 'save') {
                var answer = [];
                for(i=0;i<task.tracks.length;i++){
                    if (task.tracks[i] != null) {
                        answer.push(task.tracks[i]);
                    }
                }
                pybossa.saveTask(task.id, answer).done(function() {
                    deferred.resolve();
                });
                $("#loading").fadeIn(500);
                if ($("#disqus_thread").is(":visible")) {
                    $('#disqus_thread').toggle();
                    $('.btn-disqus').toggle();
                }
            }
            else {
                $("#error").show();
            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});

pybossa.run('antimatterbeta');
</script>
